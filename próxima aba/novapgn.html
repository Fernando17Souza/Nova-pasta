<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerador com Base em Resultado</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">üéØ Gerador de Jogos com Base nos Resultados</h1>

  <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="block font-semibold mb-1">Modalidade:</label>
      <select id="gameType" onchange="onGameTypeChange()" class="border rounded px-2 py-1 w-full">
        <option value="megasena">Mega-Sena</option>
        <option value="lotofacil">Lotof√°cil</option>
        <option value="lotomania">Lotomania</option>
      </select>
    </div>

    <div>
      <label class="block font-semibold mb-1">N√∫meros por jogo:</label>
      <input id="basePerGame" type="number" value="6" min="1" max="60" class="border rounded px-2 py-1 w-full" readonly/>
    </div>

    <div>
      <label class="block font-semibold mb-1">Qtd. Jogos:</label>
      <input id="baseQty" type="number" value="3" min="1" max="20" class="border rounded px-2 py-1 w-full"/>
    </div>
  </div>

  <div class="mb-4">
    <label class="block font-semibold mb-1">N√∫meros Base (separados por v√≠rgula):</label>
    <input id="userBase" type="text" placeholder="Ex: 5,12,23..." class="border rounded px-2 py-1 w-full mb-2"/>
    <button onclick="useUserBase()" class="bg-blue-600 text-white px-4 py-1 rounded">üé≤ Gerar com N√∫meros Digitados</button>
  </div>

  <div class="mb-4 flex flex-wrap gap-2">
    <button onclick="fetchAndGenerate()" class="bg-green-600 text-white px-4 py-1 rounded">üì• Buscar √∫ltimo resultado + gerar</button>
    <button onclick="clearResults()" class="bg-red-500 text-white px-4 py-1 rounded">üßπ Limpar Jogos</button>
    <div id="lastDisplay" class="mt-2 text-sm"></div>
  </div>

  <!-- üîß Painel de Configura√ß√µes Avan√ßadas -->
<div class="mb-6 bg-white p-4 rounded shadow">
  <h3 class="text-lg font-semibold mb-2">üîß Configura√ß√µes Avan√ßadas</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="block mb-1 font-medium">Excluir:</label>
      <div><input type="checkbox" id="noEven" /> <label for="noEven">N√∫meros pares</label></div>
      <div><input type="checkbox" id="noOdd" /> <label for="noOdd">N√∫meros √≠mpares</label></div>
      <div><input type="checkbox" id="noPrime" /> <label for="noPrime">N√∫meros primos</label></div>
    </div>
    <div>
      <label class="block mb-1 font-medium">M√≠nimo por jogo:</label>
      <div class="mb-1">
        <label>Pares:</label>
        <input type="number" id="minEven" value="0" class="w-20 px-1 py-0.5 border rounded ml-2" />
      </div>
      <div class="mb-1">
        <label>√çmpares:</label>
        <input type="number" id="minOdd" value="0" class="w-20 px-1 py-0.5 border rounded ml-2" />
      </div>
      <div>
        <label>Primos:</label>
        <input type="number" id="minPrime" value="0" class="w-20 px-1 py-0.5 border rounded ml-2" />
      </div>
    </div>
    <div class="text-sm text-gray-600">
      <p>Essas configura√ß√µes s√£o opcionais.</p>
      <p>Voc√™ pode combinar as op√ß√µes para filtrar os jogos gerados.</p>
    </div>
  </div>
</div>

<!-- üîç Estrat√©gias Avan√ßadas de Probabilidade -->
<div class="mb-6 bg-white p-4 rounded shadow">
  <h3 class="text-lg font-semibold mb-2">üìà Estrat√©gias Avan√ßadas</h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="block mb-1 font-medium">Quentes x Frios:</label>
      <select id="hotColdStrategy" class="w-full px-2 py-1 border rounded">
        <option value="balanced">Balanceado (60% quentes, 40% frios)</option>
        <option value="hot">Apenas quentes (top frequ√™ncia)</option>
        <option value="cold">Apenas frios (menos saem)</option>
        <option value="random">Mistura aleat√≥ria</option>
      </select>
    </div>

    <div>
      <label class="block mb-1 font-medium">Distribui√ß√£o por faixa:</label>
      <select id="rangeStrategy" class="w-full px-2 py-1 border rounded">
        <option value="balanced">Distribuir entre faixas (ex: 1‚Äì10, 11‚Äì20...)</option>
        <option value="free">Sem controle</option>
      </select>
    </div>
  </div>
</div>

  <h2 class="text-xl font-semibold mt-4 mb-2">Jogos Gerados:</h2>
  <div id="games" class="mb-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

  <div class="mb-4">
    <canvas id="freqChart" width="400" height="200"></canvas>
  </div>

  <div id="stats" class="mb-4"></div>
  <div id="history" class="bg-white p-4 rounded shadow"></div>

  <script>
    let allGenerated = [];
    let lastResultGlobal = [];
    let currentChart = null;
    let historicalResults = [];
    const MAX_HISTORY = 50;

    const gameConfig = {
      megasena: { urlLatest: 'https://loteriascaixa-api.herokuapp.com/api/megasena/latest', numbers: 6, max: 60, fetchHistory: fetchMegaSenaHistory },
      lotofacil: { urlLatest: 'https://loteriascaixa-api.herokuapp.com/api/lotofacil/latest', numbers: 15, max: 25, fetchHistory: fetchLotoFacilHistory },
      lotomania: { urlLatest: 'https://loteriascaixa-api.herokuapp.com/api/lotomania/latest', numbers: 50, max: 100, fetchHistory: fetchLotoManiaHistory },
    };

    function onGameTypeChange() {
      const type = document.getElementById('gameType').value;
      document.getElementById('basePerGame').value = gameConfig[type].numbers;
      clearResults();
      document.getElementById('lastDisplay').innerText = '';
      lastResultGlobal = [];
      historicalResults = [];
      document.getElementById('history').innerHTML = '';
      document.getElementById('userBase').value = '';
    }

    async function fetchLatestResult(type) {
      const res = await fetch(gameConfig[type].urlLatest);
      if (!res.ok) throw new Error('Falha ao buscar √∫ltimo resultado');
      const json = await res.json();
      return json;
    }

    // APIs n√£o oferecem hist√≥rico direto de 50 concursos, ent√£o vamos buscar um por um
    async function fetchMegaSenaHistory() {
      const lastConcursoRes = await fetch('https://loteriascaixa-api.herokuapp.com/api/megasena/latest');
      if (!lastConcursoRes.ok) throw new Error('Falha ao buscar √∫ltimo concurso da Mega-Sena');
      const lastConcursoJson = await lastConcursoRes.json();
      const lastNum = Number(lastConcursoJson.numero);

      let concursos = [];
      for(let i = 0; i < MAX_HISTORY; i++) {
        const num = lastNum - i;
        if (num <= 0) break;
        const res = await fetch(`https://loteriascaixa-api.herokuapp.com/api/megasena/${num}`);
        if (!res.ok) break;
        const json = await res.json();
        concursos.push(json);
      }
      return concursos;
    }

    async function fetchLotoFacilHistory() {
      const lastConcursoRes = await fetch('https://loteriascaixa-api.herokuapp.com/api/lotofacil/latest');
      if (!lastConcursoRes.ok) throw new Error('Falha ao buscar √∫ltimo concurso da Lotof√°cil');
      const lastConcursoJson = await lastConcursoRes.json();
      const lastNum = Number(lastConcursoJson.numero);

      let concursos = [];
      for(let i = 0; i < MAX_HISTORY; i++) {
        const num = lastNum - i;
        if (num <= 0) break;
        const res = await fetch(`https://loteriascaixa-api.herokuapp.com/api/lotofacil/${num}`);
        if (!res.ok) break;
        const json = await res.json();
        concursos.push(json);
      }
      return concursos;
    }

    async function fetchLotoManiaHistory() {
      const lastConcursoRes = await fetch('https://loteriascaixa-api.herokuapp.com/api/lotomania/latest');
      if (!lastConcursoRes.ok) throw new Error('Falha ao buscar √∫ltimo concurso da Lotomania');
      const lastConcursoJson = await lastConcursoRes.json();
      const lastNum = Number(lastConcursoJson.numero);

      let concursos = [];
      for(let i = 0; i < MAX_HISTORY; i++) {
        const num = lastNum - i;
        if (num <= 0) break;
        const res = await fetch(`https://loteriascaixa-api.herokuapp.com/api/lotomania/${num}`);
        if (!res.ok) break;
        const json = await res.json();
        concursos.push(json);
      }
      return concursos;
    }

    function renderLastResult(json, type) {
      let dezenas = json.dezenas;
      if (!Array.isArray(dezenas)) dezenas = dezenas.split(',').map(x => parseInt(x,10));
      lastResultGlobal = dezenas.filter(n => !isNaN(n));

      document.getElementById('lastDisplay').innerHTML = '√öltimo resultado: ' +
        lastResultGlobal.map(n => `<span class="inline-block bg-red-600 text-white rounded-full w-8 h-8 text-center leading-8 mx-1">${String(n).padStart(2,'0')}</span>`).join(' ');

      const historyEl = document.getElementById('history');
      historyEl.innerHTML = `
        <h3 class="text-lg font-bold mb-2">üìÖ √öltimo Concurso - ${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
        <div><strong>Concurso:</strong> ${json.numero}</div>
        <div><strong>Data:</strong> ${json.data}</div>
        <div><strong>Dezenas:</strong> ${lastResultGlobal.map(n => `<span class="inline-block bg-red-500 text-white rounded-full w-8 h-8 text-center leading-8 font-semibold mx-1">${n}</span>`).join(' ')}</div>
      `;
    }

    function calculateFrequency(historyArray, maxNumber) {
      const freqMap = new Map();
      for(let i=1; i <= maxNumber; i++) freqMap.set(i, 0);
      historyArray.forEach(concurso => {
        let dezenas = concurso.dezenas;
        if (!Array.isArray(dezenas)) dezenas = dezenas.split(',').map(x => parseInt(x,10));
        dezenas.forEach(n => {
          if (freqMap.has(n)) freqMap.set(n, freqMap.get(n) + 1);
        });
      });
      return freqMap;
    }

   function getNumbersByStrategy(freqMap, count, maxNumber) {
  const strategy = document.getElementById("hotColdStrategy").value;
  let freqArr = Array.from(freqMap.entries()).sort((a, b) => b[1] - a[1]);

  if (strategy === 'cold') freqArr.reverse();
  if (strategy === 'random') {
    freqArr = freqArr.sort(() => Math.random() - 0.5);
    return freqArr.slice(0, count).map(x => x[0]);
  }

  const hotCount = Math.ceil(count * (strategy === 'hot' ? 1 : 0.6));
  const coldCount = count - hotCount;

  const hot = freqArr.slice(0, count * 2).map(x => x[0]);
  const cold = freqArr.slice(-count * 2).map(x => x[0]);

  const selected = [
    ...getRandomSubset(hot, Math.min(hotCount, hot.length)),
    ...getRandomSubset(cold, Math.min(coldCount, cold.length))
  ];

  return selected.slice(0, count);
}

 function generateGame(perGame, fixedNumbers, freqMap, maxNumber) {
  const needed = perGame - fixedNumbers.length;
  let pool = [];
  for (let i = 1; i <= maxNumber; i++) {
    if (!fixedNumbers.includes(i)) pool.push(i);
  }

  pool = pool.filter(n => !lastResultGlobal.includes(n));

  const noEven = document.getElementById("noEven").checked;
  const noOdd = document.getElementById("noOdd").checked;
  const noPrime = document.getElementById("noPrime").checked;

  pool = pool.filter(n => {
    if (noEven && n % 2 === 0) return false;
    if (noOdd && n % 2 !== 0) return false;
    if (noPrime && isPrime(n)) return false;
    return true;
  });

  const filteredFreq = new Map();
  pool.forEach(n => filteredFreq.set(n, freqMap.get(n) || 0));

  const minEven = parseInt(document.getElementById("minEven").value) || 0;
  const minOdd = parseInt(document.getElementById("minOdd").value) || 0;
  const minPrime = parseInt(document.getElementById("minPrime").value) || 0;
  const rangeStrategy = document.getElementById("rangeStrategy").value;

  let attempt = 0;
  while (attempt < 2000) {
    const smartNumbers = getNumbersByStrategy(filteredFreq, needed, maxNumber);
    const fullGame = [...fixedNumbers, ...smartNumbers].sort((a, b) => a - b);

    const countEven = fullGame.filter(n => n % 2 === 0).length;
    const countOdd = fullGame.length - countEven;
    const countPrime = fullGame.filter(isPrime).length;

    // Estrat√©gia por faixa (1‚Äì10, 11‚Äì20, ...)
    const ranges = {};
    fullGame.forEach(n => {
      const faixa = Math.floor((n - 1) / 10);
      ranges[faixa] = (ranges[faixa] || 0) + 1;
    });

    const faixaOk = rangeStrategy === "free" || Object.keys(ranges).length >= Math.ceil(perGame / 3);

    if (
      countEven >= minEven &&
      countOdd >= minOdd &&
      countPrime >= minPrime &&
      faixaOk
    ) {
      return fullGame;
    }
    attempt++;
  }

  return [...fixedNumbers, ...getNumbersByStrategy(filteredFreq, needed, maxNumber)].sort((a, b) => a - b);
}

    function getRandomSubset(array, size) {
      const shuffled = [...array];
      for(let i = shuffled.length -1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i+1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled.slice(0,size);
    }

    function testGameInHistory(gameArray, history) {
      for(const concurso of history) {
        let dezenas = concurso.dezenas;
        if(!Array.isArray(dezenas)) dezenas = dezenas.split(',').map(x => parseInt(x,10));
        const acertos = gameArray.filter(n => dezenas.includes(n)).length;
        if(acertos === gameArray.length) {
          return { won: true, concurso: concurso.numero, data: concurso.data, acertos };
        }
      }

      let maxAcertos = 0;
      let bestConcurso = null;
      for(const concurso of history) {
        let dezenas = concurso.dezenas;
        if(!Array.isArray(dezenas)) dezenas = dezenas.split(',').map(x => parseInt(x,10));
        const acertos = gameArray.filter(n => dezenas.includes(n)).length;
        if(acertos > maxAcertos) {
          maxAcertos = acertos;
          bestConcurso = concurso;
        }
      }
      if(maxAcertos > 0) {
        return { won: false, concurso: bestConcurso.numero, data: bestConcurso.data, acertos: maxAcertos };
      }
      return { won: false, acertos: 0 };
    }

    function isPrime(n) {
      if (n < 2) return false;
      for(let i = 2; i <= Math.sqrt(n); i++) {
        if(n % i === 0) return false;
      }
      return true;
    }

    async function fetchAndGenerate() {
      clearResults();
      const type = document.getElementById('gameType').value;
      const perGame = gameConfig[type].numbers;
      const maxNumber = gameConfig[type].max;
      const qty = parseInt(document.getElementById('baseQty').value) || 3;

      document.getElementById('lastDisplay').innerText = 'Carregando resultados...';

      try {
        const latest = await fetchLatestResult(type);
        renderLastResult(latest, type);

        historicalResults = await gameConfig[type].fetchHistory();

        // Frequ√™ncia real hist√≥rica
        const freqMap = calculateFrequency(historicalResults, maxNumber);

        let fixedNumbers = [];
        if(type === 'lotomania' || type === 'lotofacil') {
          fixedNumbers = getRandomSubset(lastResultGlobal, 5);
        }

        allGenerated = [];
        const generatedSet = new Set();
        const gamesDiv = document.getElementById('games');
        gamesDiv.innerHTML = '';

        let attempts = 0;
        while(generatedSet.size < qty && attempts < 3000) {
          let game;
          if(type === 'megasena') {
            // Mega Sena: n√£o pode conter n√∫meros do √∫ltimo resultado
            const pool = Array.from({length: maxNumber}, (_, i) => i + 1)
              .filter(n => !lastResultGlobal.includes(n));
            game = getRandomSubset(pool, perGame).sort((a,b) => a-b);
          } else {
            game = generateGame(perGame, fixedNumbers, freqMap, maxNumber);
          }

          const key = game.join(',');
          if(!generatedSet.has(key)) {
            // Evita jogo igual ao √∫ltimo no Mega-Sena
            if(!(type === 'megasena' && key === lastResultGlobal.slice().sort((a,b) => a-b).join(','))) {
              generatedSet.add(key);
              allGenerated.push(...game);

              const test = testGameInHistory(game, historicalResults);

              const div = document.createElement('div');
              div.className = 'bg-white p-3 rounded shadow';

              div.innerHTML = `
                <div class="mb-2">
                  ${game.map(n => {
                    const isLast = lastResultGlobal.includes(n);
                    return `<span class="inline-block ${isLast ? 'bg-green-600' : 'bg-blue-600'} text-white rounded-full w-8 h-8 text-center leading-8 mx-1">${String(n).padStart(2,'0')}</span>`;
                  }).join('')}
                </div>
                <div class="text-sm text-gray-700">
                  ${test.won ? 
                    `<strong class="text-green-700">Jogo j√° ganhou no concurso ${test.concurso} (${test.data})! üéâ</strong>` : 
                    (test.acertos > 0 ? `Maior acerto: ${test.acertos} n√∫meros no concurso ${test.concurso} (${test.data})` : 'Nunca saiu nos √∫ltimos 50 concursos.')}
                </div>
              `;
              gamesDiv.appendChild(div);
            }
          }
          attempts++;
          if(attempts >= 3000) {
            console.warn('Limite de tentativas atingido.');
            break;
          }
        }

        // Estat√≠sticas dos jogos gerados
        const freq = {};
        allGenerated.forEach(n => freq[n] = (freq[n] || 0) + 1);
        const sortedFreq = Object.entries(freq).sort((a,b) => b[1] - a[1]);

        const pares = allGenerated.filter(n => n % 2 === 0).length;
        const impares = allGenerated.length - pares;
        const primos = allGenerated.filter(isPrime).length;

        const statsEl = document.getElementById('stats');
        const mediaAcertos = allGenerated.length
          ? (allGenerated.filter(n => lastResultGlobal.includes(n)).length / (allGenerated.length / perGame))
          : 0;

        statsEl.innerHTML = `
          <h3 class="font-semibold text-lg mb-2">üìä Estat√≠sticas dos Jogos Gerados:</h3>
          <div><strong>N√∫meros mais gerados:</strong> ${sortedFreq.slice(0, 5).map(([n,c]) => `${n}(${c})`).join(', ')}</div>
          <div><strong>M√©dia de acertos por jogo:</strong> ${mediaAcertos.toFixed(2)}</div>
          <div><strong>Total Pares:</strong> ${pares}, <strong>√çmpares:</strong> ${impares}, <strong>Primos:</strong> ${primos}</div>
        `;

        renderChart(freq);

      } catch (error) {
        document.getElementById('lastDisplay').innerText = `‚ùå ${error.message}`;
      }
    }

    function useUserBase() {
      clearResults();
      const baseCsv = document.getElementById('userBase').value;
      const gamesQty = parseInt(document.getElementById('baseQty').value) || 1;
      const perGame = parseInt(document.getElementById('basePerGame').value) || 6;

      const baseNums = baseCsv.split(',')
        .map(n => parseInt(n.trim()))
        .filter(n => !isNaN(n));

      if(baseNums.length < perGame) {
        alert(`Insira pelo menos ${perGame} n√∫meros v√°lidos.`);
        return;
      }

      const generatedSet = new Set();
      allGenerated = [];
      const gamesDiv = document.getElementById('games');
      gamesDiv.innerHTML = '';

      let attempts = 0;
      while(generatedSet.size < gamesQty && attempts < 1000) {
        const gameArray = getRandomSubset(baseNums, perGame).sort((a,b) => a-b);
        const key = gameArray.join(',');

        if(!generatedSet.has(key)) {
          generatedSet.add(key);

          const div = document.createElement('div');
          div.className = 'bg-white p-3 rounded shadow mb-2';
          div.innerHTML = gameArray.map(n => {
            const isLast = lastResultGlobal.includes(n);
            return `<span class="inline-block ${isLast ? 'bg-green-600' : 'bg-blue-600'} text-white rounded-full w-8 h-8 text-center leading-8 mx-1">${String(n).padStart(2,'0')}</span>`;
          }).join('');

          gamesDiv.appendChild(div);
          allGenerated.push(...gameArray);
        }
        attempts++;
      }

      // Estat√≠sticas simples
      const freq = {};
      allGenerated.forEach(n => freq[n] = (freq[n] || 0) + 1);
      renderChart(freq);
    }

    function clearResults() {
      document.getElementById('games').innerHTML = '';
      document.getElementById('stats').innerHTML = '';
      document.getElementById('lastDisplay').innerText = '';
      document.getElementById('history').innerHTML = '';
      allGenerated = [];
      lastResultGlobal = [];
      historicalResults = [];
      if(currentChart) {
        currentChart.destroy();
        currentChart = null;
      }
    }

    function renderChart(freqMap) {
      if(currentChart) currentChart.destroy();
      const ctx = document.getElementById('freqChart').getContext('2d');

      // Ordena labels numericamente
      const labels = Object.keys(freqMap).map(Number).sort((a,b) => a-b);
      const data = labels.map(l => freqMap[l] || 0);

      currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Frequ√™ncia dos N√∫meros Gerados',
            data,
            backgroundColor: 'rgba(33, 150, 243, 0.6)'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Inicializa input na carga da p√°gina
    onGameTypeChange();
  </script>
</body>
</html>
